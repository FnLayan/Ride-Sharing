<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>استكشاف الرحلات</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');
    :root{--bg:#f8f3ee;--card:#fffdf9;--border:#ddd0c8;--accent:#cbb796;--accent-hover:#b29a75;--text:#3b2f24;--muted:#7a6a57;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:var(--bg);font-family:'Tajawal',sans-serif;color:var(--text)}
    .wrap{max-width:950px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.08);padding:16px}
    h1{margin:0 0 10px;font-size:22px;color:var(--muted);text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 4px}
    input,select{width:100%;padding:10px;border:1px solid #e6dcca;border-radius:8px;background:#fff;font-size:14px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn:hover{background:var(--accent-hover)}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .seg button{background:#fff;border:0;padding:10px 14px;cursor:pointer}
    .seg button.active{background:var(--accent);color:#fff}
    .muted{color:#7a6a57;font-size:13px}
    .map{height:260px;background:#fffdf9;border:1px dashed #e0d6c8;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-top:8px}
    .results{margin-top:14px}
    .ride{border:1px solid #efe6db;border-radius:10px;padding:12px;margin-bottom:10px;background:#fff}
    .ride h3{margin:0 0 6px;font-size:16px}
    .badge{display:inline-block;background:#eee;border:1px solid #e1d6c7;border-radius:999px;padding:3px 8px;font-size:12px;margin-inline-start:6px}
    .right{float:left}
    .sep{height:1px;background:#f0e8de;margin:10px 0}
    .empty{padding:12px;border:1px dashed #decfbf;border-radius:10px;background:#fff;text-align:center;color:#7a6a57}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>استكشاف الرحلات</h1>

      
      <div class="row" style="justify-content:center;margin-bottom:10px">
        <div class="seg" role="tablist" aria-label="search mode">
          <button id="tabNearby" class="active" onclick="setMode('nearby')" role="tab" aria-selected="true">الرحلات القريبة</button>
          <button id="tabMatch" onclick="setMode('match')" role="tab" aria-selected="false">أفضل مطابقة</button>
        </div>
      </div>

     
      <div class="row">
        <div class="col">
          <label>نقطة الانطلاق (اختياري)</label>
          <input id="fromText" type="text" placeholder="مثال:  بيتي">
          <div class="row">
            <div class="col">
              <label>خط العرض (lat)</label>
              <input id="fromLat" type="number" step="0.000001" placeholder="24.7">
            </div>
            <div class="col">
              <label>خط الطول (lng)</label>
              <input id="fromLng" type="number" step="0.000001" placeholder="46.7">
            </div>
          </div>
        </div>
        <div class="col">
          <label>الوجهة (اختياري للمطابقة)</label>
          <input id="toText" type="text" placeholder="مثال: الجامعة - مبنى 24 ">
          <div class="row">
            <div class="col">
              <label>lat</label>
              <input id="toLat" type="number" step="0.000001" placeholder="24.65">
            </div>
            <div class="col">
              <label>lng</label>
              <input id="toLng" type="number" step="0.000001" placeholder="46.71">
            </div>
          </div>
        </div>
        <div class="col">
          <label>وقت المغادرة المرغوب</label>
          <input id="when" type="datetime-local">
          <div class="row">
            <div class="col">
              <label>نصف القطر (كم)</label>
              <input id="radiusKm" type="number" min="1" step="1" value="5">
            </div>
            <div class="col">
              <label>نافذة زمنية (± دقيقة)</label>
              <input id="timeWindow" type="number" min="0" step="5" value="30">
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;align-items:center">
        <button class="btn" onclick="runSearch()">بحث</button>
        
        <button class="btn right" onclick="history.back()">رجوع</button>
      </div>

      
      <div class="map muted">خريطة (Placeholder)</div>

      
      <div id="results" class="results"></div>
    </div>
  </div>

  <script>
 
    function haversineKm(a,b){
      if(!a||!b||a.lat==null||a.lng==null||b.lat==null||b.lng==null) return Infinity;
      const toRad = d=>d*Math.PI/180;
      const R=6371, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }
    const fmtTime = iso => new Date(iso).toLocaleString();
    const diffMin = (a,b)=> Math.round(Math.abs(new Date(a)-new Date(b))/60000);

    
    function loadRides(){
      const raw = localStorage.getItem('rs_rides');
      let arr = [];
      if(raw){ try{ arr = JSON.parse(raw)||[]; }catch(e){} }
      if(!arr.length){
     
        arr = [
          {id:'r1',driverId:'uD1',
            from:{lat:24.7136,lng:46.6753,name:'Olaya Exit 8'},
            to:{lat:24.7240,lng:46.6210,name:'Imam Univ - Gate 3'},
            departAt: new Date(Date.now()+60*60*1000).toISOString(), seats:3, notes:'Morning ride', price:0},
          {id:'r2',driverId:'uD2',
            from:{lat:24.7100,lng:46.6800,name:'King Fahd Rd'},
            to:{lat:24.7240,lng:46.6210,name:'Imam Univ - Gate 1'},
            departAt: new Date(Date.now()+90*60*1000).toISOString(), seats:1, notes:'Fast lane', price:0},
          {id:'r3',driverId:'uD3',
            from:{lat:24.6800,lng:46.7200,name:'Al Yasmin'},
            to:{lat:24.7240,lng:46.6210,name:'Imam Univ - Gate 2'},
            departAt: new Date(Date.now()+45*60*1000).toISOString(), seats:2, notes:'Female only', price:0},
        ];
        localStorage.setItem('rs_rides', JSON.stringify(arr));
      }
      return arr;
    }

    
    const LocationSearchService = {
      search({rides, userFrom, whenISO, radiusKm=5, windowMin=30}){
        return rides
          .map(r=>{
            const d = haversineKm(userFrom, r.from);
            const tOk = whenISO ? (diffMin(r.departAt, whenISO) <= windowMin) : true;
            return {...r, _dist:d, _timeDiff: whenISO? diffMin(r.departAt, whenISO): null, _ok: d<=radiusKm && tOk};
          })
          .filter(x=>x._ok)
          .sort((a,b)=> (a._dist-b._dist) || (new Date(a.departAt)-new Date(b.departAt)));
      }
    };

    const RideMatchingService = {
      match({rides, userFrom, userTo, whenISO, windowMin=30, w1=2.0, w2=2.0, w3=0.5}){
        return rides
          .filter(r=> r.seats>0)
          .map(r=>{
            const dStart = userFrom? haversineKm(userFrom, r.from) : 0;
            const dEnd   = (userTo && r.to) ? haversineKm(userTo, r.to) : 0;
            const tMin   = whenISO ? diffMin(r.departAt, whenISO) : 0;

            
            const timeOk = whenISO ? (tMin<= (windowMin*2)) : true;

            
            let score = 100 - (w1*dStart) - (w2*dEnd) - (w3*Math.min(tMin,120));
            if(!timeOk) score -= 50;

            return {...r, _dStart:dStart, _dEnd:dEnd, _tMin:tMin, _score:score};
            })
          .filter(x=>x._score>0)
          .sort((a,b)=> b._score - a._score);
      }
    };

    let MODE = 'nearby'; 
    function setMode(m){
      MODE = m;
      document.getElementById('tabNearby').classList.toggle('active', m==='nearby');
      document.getElementById('tabMatch').classList.toggle('active', m==='match');
      runSearch();
    }

    function getUserPoints(){
      const fLat = parseFloat(document.getElementById('fromLat').value);
      const fLng = parseFloat(document.getElementById('fromLng').value);
      const tLat = parseFloat(document.getElementById('toLat').value);
      const tLng = parseFloat(document.getElementById('toLng').value);

      const from = (isFinite(fLat)&&isFinite(fLng)) ? {lat:fLat,lng:fLng,name:document.getElementById('fromText').value||'Your start'} : null;
      const to   = (isFinite(tLat)&&isFinite(tLng)) ? {lat:tLat,lng:tLng,name:document.getElementById('toText').value||'Your dest'} : null;
      return {from,to};
    }

    function runSearch(){
      const rides = loadRides();
      const {from:userFrom, to:userTo} = getUserPoints();
      const whenISO = document.getElementById('when').value ? new Date(document.getElementById('when').value).toISOString() : null;
      const radiusKm = parseFloat(document.getElementById('radiusKm').value)||5;
      const windowMin= parseInt(document.getElementById('timeWindow').value||'30',10);

      let out = [];
      if(MODE==='nearby'){
        if(!userFrom){
         
          out = rides
            .map(r=>({...r,_dist: r.from? haversineKm({lat:24.7136,lng:46.6753}, r.from):999}))
            .sort((a,b)=>a._dist-b._dist)
            .slice(0,5);
        }else{
          out = LocationSearchService.search({rides, userFrom, whenISO, radiusKm, windowMin});
        }
      }else{
        out = RideMatchingService.match({rides, userFrom, userTo, whenISO, windowMin});
      }

      renderResults(out);
    }

    function renderResults(items){
      const box = document.getElementById('results');
      if(!items.length){
        box.innerHTML = '<div class="empty">لا توجد نتائج مطابقة للمدخلات الحالية.</div>';
        return;
      }
      let html = '';
      items.forEach(r=>{
        html += `
          <div class="ride">
            <h3>${escapeHtml(r.from?.name||'From ?')} → ${escapeHtml(r.to?.name||'To ?')}
              ${MODE==='match'
                ? <span class="badge">Score: ${Math.round(r._score||0)}</span>
                : <span class="badge">${r._dist!=null && isFinite(r._dist)? r._dist.toFixed(1)+' كم':''}</span>
              }
            </h3>
            <div class="muted">المغادرة: ${fmtTime(r.departAt)} · المقاعد المتاحة: ${r.seats}</div>
            ${MODE==='match'
              ? <div class="muted">dStart≈ ${r._dStart?.toFixed(1)||'-'} كم · dEnd≈ ${r._dEnd?.toFixed(1)||'-'} كم · Δt≈ ${r._tMin??'-'} د</div>
              : (r._timeDiff!=null? <div class="muted">فرق الوقت: ± ${r._timeDiff} دقيقة</div>:'')
            }
            <div class="sep"></div>
            <div class="row" style="justify-content:space-between;align-items:center">
              <span class="muted">${escapeHtml(r.notes||'')}</span>
              <button class="btn" onclick="requestJoin('${r.id}')">طلب انضمام</button>
            </div>
          </div>
        `;
      });
      box.innerHTML = html;
    }

    function requestJoin(rideId){
      //لسا ما سوينا واجهة السواق لكن هذي للتجريب
      alert('تم إرسال طلب انضمام للرحلة: '+ rideId + ' (واجهة تجريبية)');
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    (function init(){
      runSearch();
    })();
  </script>
</body>
</html>