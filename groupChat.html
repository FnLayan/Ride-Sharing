<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');
    :root{
      --bg:#f8f3ee;--card:#fffdf9;--border:#ddd0c8;
      --accent:#cbb796;--accent-hover:#b29a75;
      --text:#3b2f24;--muted:#7a6a57;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family:'Tajawal',sans-serif;
      color:var(--text);
    }
    .wrap{
      max-width:900px;
      margin:20px auto;
      padding:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 26px rgba(0,0,0,.08);
    }
    h1{
      text-align:center;
      font-size:21px;
      margin-bottom:10px;
      color:var(--muted)
    }
    .section{
      margin-top:14px;
      border-top:1px solid #efe6db;
      padding-top:10px;
    }
    .section:first-of-type{
      border-top:none;
      padding-top:0;
    }
    .label{
      font-weight:700;
      font-size:14px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }
    .small{
      font-size:12px;
      color:#a1907f;
      margin-top:2px;
    }
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .btn:hover{background:var(--accent-hover)}
    .btn-sm{
      padding:5px 8px;
      font-size:12px;
    }
    .btn-ghost{
      background:#fff;
      color:var(--muted);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{
      background:#f3ebe0;
    }
    input{
      padding:8px;
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      margin-top:4px;
      background:#fff;
      font-family:'Tajawal',sans-serif;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .col{
      flex:1;
      min-width:200px;
    }
    .group{
      border:1px solid #efe6db;
      border-radius:10px;
      padding:9px 10px;
      background:#fff;
      margin-bottom:6px;
      cursor:pointer;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .group-title{
      font-weight:700;
    }
    .group-owner{
      font-size:11px;
      color:#a1907f;
    }
    .pill{
      font-size:11px;
      border-radius:999px;
      padding:2px 8px;
      border:1px solid #decfbf;
      background:#fffaf3;
      color:#7a6a57;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
    }
    .muted-sm{
      color:var(--muted);
      font-size:12px;
    }
    .chat-box{
      height:320px;
      border:1px solid #efe6db;
      background:#fff;
      border-radius:10px;
      padding:10px;
      overflow-y:auto;
      margin-top:10px;
    }
    .msg-wrap{
      margin:6px 0;
      max-width:85%;
    }
    .msg-wrap.me{
      margin-left:auto;
      text-align:left;
    }
    .meta{
      font-size:11px;
      color:#816c5a;
      margin-bottom:2px;
      display:flex;
      justify-content:flex-start;
      gap:6px;
      align-items:center;
    }
    .msg{
      background:#eee;
      padding:6px 10px;
      border-radius:10px;
      font-size:14px;
      display:inline-block;
    }
    .msg.me{
      background:#d8c4a9;
    }
    .role-badge{
      font-size:11px;
      border-radius:999px;
      padding:2px 6px;
      border:1px solid #decfbf;
      background:#fffaf3;
    }
    .time{
      font-size:10px;
      color:#b3a392;
    }
    .inv-card{
      border:1px dashed #e0cdb6;
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      margin-bottom:6px;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .inv-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .tag{
      font-size:11px;
      color:#9a8b7a;
    }
    .danger{
      color:#b5534a;
    }
    .center{
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>
      <button onclick="goHome()" 
        style="margin:8px; padding:6px 10px; background:#b29a75; color:#fff; border:none; border-radius:6px; cursor:pointer;">
         Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>

      <div id="noUser" class="section" style="display:none">
        <p class="muted center">
          Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.<br>
          Ø§Ø¯Ø®Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ ÙƒÙ€ Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ø§ÙƒØ¨ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.
        </p>
      </div>

      <div id="mainContent" style="display:none">
        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨ -->
        <div class="section">
          <span class="label">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨ Ø¬Ø¯ÙŠØ¯:</span>
          <div class="row">
            <div class="col">
              <input id="groupName" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø±ÙˆØ¨ Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠ"/>
              <div class="small">
                Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… (Ø±Ø§ÙƒØ¨ Ø£Ùˆ Ø³Ø§Ø¦Ù‚) ÙŠÙ‚Ø¯Ø± ÙŠÙ†Ø´Ø¦ Ù‚Ø±ÙˆØ¨ Ø¹Ø§Ù… Ù„Ø¬Ø§Ù…Ø¹ØªÙ‡ Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹ØªÙ‡.
              </div>
            </div>
            <button class="btn" type="button" onclick="createGroup()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙˆØ¨</button>
          </div>
        </div>

        <!-- Ø¯Ø¹ÙˆØ§ØªÙƒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ù‡ -->
        <div class="section">
          <span class="label">Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ:</span>
          <div id="inviteList"></div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª -->
        <div class="section">
          <span class="label">Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØªÙŠ Ø£Ù†Øª Ø¹Ø¶Ùˆ ÙÙŠÙ‡Ø§:</span>
          <div id="groupList"></div>
        </div>

        <!-- Ø¯Ø¹ÙˆØ© Ø¹Ø¶Ùˆ Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ -->
        <div class="section" id="inviteSection" style="display:none">
          <span class="label">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span>
          <div class="row">
            <div class="col">
              <input id="inviteEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ"/>
              <div class="small">
                Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù„Ù† ÙŠØ¯Ø®Ù„ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚ØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆØ©.
              </div>
              <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ -->
            <div id="inviteError" class="small danger" style="display:none;margin-top:4px;"></div>
            </div>
            <button class="btn" type="button" onclick="inviteUser()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©</button>
          </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div id="chatSection" class="section" style="display:none">
          <span class="label" id="chatTitle"></span>
          <div class="small" id="chatHint"></div>
          <div id="chatBox" class="chat-box"></div>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."/>
            </div>
            <button class="btn" type="button" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script src="notifications-bar.js"></script>
<script>
  function load(key){ try{return JSON.parse(localStorage.getItem(key)||'[]');}catch(e){return[];} }
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function uid(){ return 'id'+Date.now()+Math.floor(Math.random()*1000); }

  function fmtTimeShort(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }

  function alertMsg(m){ alert(m); }

  const currentUserId = localStorage.getItem('rs_current_user_id') || '';
  const currentRole   = localStorage.getItem('rs_current_role') || ''; 
  let users    = load('rs_users');
  let groups   = load('rs_groups');         
  let members  = load('rs_group_members'); 
  let messages = load('rs_group_msgs');     

  let currentGroupId = null;

  function getUser(id){ return users.find(u=>u.id===id) || null; }

  function ensureUser(){
    if(!currentUserId){
      document.getElementById('noUser').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      return false;
    }
    document.getElementById('noUser').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    return true;
  }

  // ===== Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±ÙˆØ¨ =====
  function createGroup(){
    if(!ensureUser()) return;

    const nameEl = document.getElementById('groupName');
    const name   = nameEl.value.trim();
    if(!name){
      alertMsg('Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }

    const id = uid();
    const g = {id, name, owner: currentUserId};
    groups.push(g);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´Ø¦ Ø§Ù„Ù‚Ø±ÙˆØ¨ ÙƒØ¹Ø¶Ùˆ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ù‡
    members.push({
      groupId: id,
      userId: currentUserId,
      role: currentRole,
      userRole: currentRole,
      approved: true,
      invitedBy: currentUserId,
      createdAt: new Date().toISOString()
    });

    save('rs_groups', groups);
    save('rs_group_members', members);

    nameEl.value = '';
    currentGroupId = id;
    renderGroups();
    renderInvites();
    openChat(id);
  }

  // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØªÙŠ Ø£Ù†Ø§ Ø¹Ø¶Ùˆ ÙÙŠÙ‡Ø§ =====
  function renderGroups(){
    if(!ensureUser()) return;

    const list = document.getElementById('groupList');
    const myMemberships = members.filter(
      m => m.userId === currentUserId && m.approved
    );

    if(!myMemberships.length){
      list.innerHTML = '<div class="muted-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±ÙˆØ¨Ø§Øª Ø§Ù†Ø¶Ù…Ù…ØªÙ Ù„Ù‡Ø§ Ø¨Ø¹Ø¯.</div>';
      document.getElementById('inviteSection').style.display = 'none';
      document.getElementById('chatSection').style.display = 'none';
      return;
    }

    let html = '';
    myMemberships.forEach(m=>{
      const g = groups.find(x=>x.id===m.groupId);
      if(!g) return;
      const owner = getUser(g.owner);
      const ownerName = owner ? owner.name : 'Ù…Ø³ØªØ®Ø¯Ù…';
      const amOwner = (g.owner === currentUserId);

      html += `
        <div class="group" onclick="openChat('${g.id}')">
          <div>
            <div class="group-title">${g.name}</div>
            <div class="group-owner">Ø§Ù„Ù…Ù†Ø´Ø¦: ${ownerName}</div>
          </div>
          <div class="pill">
            ${amOwner ? 'Ø£Ù†Øª Ù…Ù†Ø´Ø¦ Ø§Ù„Ù‚Ø±ÙˆØ¨' : 'Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨'}
          </div>
        </div>
      `;
    });

    list.innerHTML = html;
  }

  // ===== Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ =====
  function renderInvites(){
    if(!ensureUser()) return;
    const box = document.getElementById('inviteList');

    const pending = members.filter(
      m => m.userId === currentUserId && !m.approved
    );

    if(!pending.length){
      box.innerHTML = '<div class="muted-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ù‚Ø±ÙˆØ¨Ø§Øª ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ.</div>';
      return;
    }

    let html = '';
    pending.forEach(m=>{
      const g = groups.find(x=>x.id===m.groupId);
      if(!g) return;
      const inviter = getUser(m.invitedBy);
      const invName = inviter ? inviter.name : 'Ù…Ø³ØªØ®Ø¯Ù…';
      html += `
        <div class="inv-card">
          <div class="inv-main">
            <div><strong>${g.name}</strong></div>
            <div class="tag">Ø¯Ø¹ÙˆØ© Ù…Ù†: ${invName}</div>
            <div class="tag">Ø¯ÙˆØ±Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨: ${
              (m.role === 'driver' || m.userRole === 'driver')
                ? 'ğŸš— Ø³Ø§Ø¦Ù‚'
                : 'ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨'
            }</div>
          </div>
          <div>
            <button class="btn btn-sm" type="button" onclick="acceptInvite('${g.id}')">Ù‚Ø¨ÙˆÙ„</button>
            <button class="btn btn-sm btn-ghost" type="button" onclick="rejectInvite('${g.id}')">Ø±ÙØ¶</button>
          </div>
        </div>
      `;
    });

    box.innerHTML = html;
  }

  function acceptInvite(groupId){
    const idx = members.findIndex(
      m => m.groupId === groupId && m.userId === currentUserId && !m.approved
    );
    if(idx === -1) return;
    members[idx].approved = true;
    members[idx].approvedAt = new Date().toISOString();
    save('rs_group_members', members);

    // Ø±Ø³Ø§Ù„Ø© Ø§Ù†Ø¶Ù…Ø§Ù…ÙŠØ© Ø¨Ø³ÙŠØ·Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø±ÙˆØ¨:
    messages.push({
      id: uid(),
      groupId,
      from: '_system',
      text: (getUser(currentUserId)?.name || 'Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯') + ' Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø±ÙˆØ¨.',
      createdAt: new Date().toISOString()
    });
    save('rs_group_msgs', messages);

    renderInvites();
    renderGroups();
  }

  function rejectInvite(groupId){
    const newMembers = members.filter(
      m => !(m.groupId === groupId && m.userId === currentUserId && !m.approved)
    );
    members = newMembers;
    save('rs_group_members', members);
    renderInvites();
    renderGroups();
  }

  // ===== Ø¯Ø¹ÙˆØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ =====
  function inviteUser(){
    if(!ensureUser()) return;
  if(!currentGroupId){
    alertMsg('Ø§Ø®ØªØ§Ø±ÙŠ Ù‚Ø±ÙˆØ¨Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
    return;
  }

  const myMembership = members.find(
    m => m.groupId === currentGroupId && m.userId === currentUserId && m.approved
  );
  if(!myMembership){
      alertMsg('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¯Ø¹ÙˆØ© Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù‚Ø¨Ù„ Ø£Ù† ØªÙƒÙˆÙ†ÙŠ Ø¹Ø¶ÙˆÙ‹Ø§ ÙÙŠÙ‡.');
      return;
    }

    const emailInput = document.getElementById('inviteEmail');
    const errorBox   = document.getElementById('inviteError');

    // Ù†ÙØ¶ÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if(errorBox){
      errorBox.style.display = 'none';
      errorBox.textContent   = '';
    }

    const email = emailInput.value.trim();
    if(!email){
      if(errorBox){
       errorBox.textContent = 'Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ø¶Ùˆ.';
        errorBox.style.display = 'block';
      }else{
        alertMsg('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ø¶Ùˆ.');
      }
      emailInput.focus();
      return;
    }

    const user = users.find(u => u.email === email);
    if(!user){
      if(errorBox){
        errorBox.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ£ÙƒÙ‘Ø¯ÙŠ Ù…Ù† ÙƒØªØ§Ø¨ØªÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.';
        errorBox.style.display = 'block';
      }else{
        alertMsg('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
      }
      return;
    }

    const existing = members.find(
      m => m.groupId === currentGroupId && m.userId === user.id
    );
    if(existing){
      if(errorBox){
        errorBox.textContent = existing.approved
          ? 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨.'
          : 'Ù‡Ù†Ø§Ùƒ Ø¯Ø¹ÙˆØ© Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨.';
        errorBox.style.display = 'block';
      }else{
        alertMsg(existing.approved
          ? 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨.'
          : 'Ù‡Ù†Ø§Ùƒ Ø¯Ø¹ÙˆØ© Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨.'
        );
      }
      return;
    }

    // ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ…Ø§Ù… Ø¹Ø§Ø¯ÙŠ Ù†Ø±Ø³Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©
    members.push({
      groupId: currentGroupId,
      userId: user.id,
      role: user.role,
      userRole: user.role,
      approved: false,
      invitedBy: currentUserId,
      createdAt: new Date().toISOString()
    });
    save('rs_group_members', members);

  emailInput.value = '';
  if(errorBox){
    errorBox.style.display = 'none';
    errorBox.textContent = '';
  }

  alertMsg('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©ØŒ ÙˆØ³ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.');
}

  // ===== ÙØªØ­ Ù‚Ø±ÙˆØ¨ ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© =====
  function openChat(groupId){
    if(!ensureUser()) return;

    // ØªØ£ÙƒÙ‘Ø¯ Ø£Ù†Ù‡ Ø¹Ø¶Ùˆ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡
    const myMembership = members.find(
      m => m.groupId === groupId && m.userId === currentUserId && m.approved
    );
    if(!myMembership){
      alertMsg('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø±ÙˆØ¨ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆØ©.');
      return;
    }

    currentGroupId = groupId;

    document.getElementById('inviteSection').style.display = 'block';
    document.getElementById('chatSection').style.display   = 'block';

    const g = groups.find(x=>x.id===groupId);
    const chatTitle = document.getElementById('chatTitle');
    const chatHint  = document.getElementById('chatHint');

    const owner = getUser(g.owner);
    const ownerName = owner ? owner.name : 'Ù…Ø³ØªØ®Ø¯Ù…';

    chatTitle.textContent = 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ' + g.name;
    chatHint.textContent =
      'Ø§Ù„Ù…Ù†Ø´Ø¦: ' + ownerName +
      ' Â· Ø£ÙŠ Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨ ÙŠÙ‚Ø¯Ø± ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙˆÙŠØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.';

    loadChatMessages();
  }

  function loadChatMessages(){
    if(!currentGroupId) return;
    const box = document.getElementById('chatBox');
    box.innerHTML = '';

    const groupMsgs = messages
      .filter(m => m.groupId === currentGroupId)
      .sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));

    if(!groupMsgs.length){
      box.innerHTML = '<div class="muted-sm center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†.</div>';
      return;
    }

    groupMsgs.forEach(m=>{
      if(m.from === '_system'){
        const div = document.createElement('div');
        div.className = 'muted-sm center';
        div.textContent = m.text + ' (' + fmtTimeShort(m.createdAt) + ')';
        box.appendChild(div);
        return;
      }

      const u = getUser(m.from);
      const name = u ? u.name : 'Ù…Ø³ØªØ®Ø¯Ù…';
      const role = u ? (u.role === 'driver' ? ' Ø³Ø§Ø¦Ù‚' : (u.role === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„' : 'Ø±Ø§ÙƒØ¨')) : 'Ø¹Ø¶Ùˆ';
      const mine = (m.from === currentUserId);

      const wrap = document.createElement('div');
      wrap.className = 'msg-wrap' + (mine ? ' me' : '');

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <span>${name}</span>
        <span class="role-badge">${role}</span>
        <span class="time">${fmtTimeShort(m.createdAt)}</span>
      `;

      const msg = document.createElement('div');
      msg.className = 'msg' + (mine ? ' me' : '');
      msg.textContent = m.text;

      wrap.appendChild(meta);
      wrap.appendChild(msg);
      box.appendChild(wrap);
    });

    box.scrollTop = box.scrollHeight;
  }

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© =====
  function sendMsg(){
    if(!ensureUser()) return;
    if(!currentGroupId){
      alertMsg('Ø§Ø®ØªØ§Ø±ÙŠ Ù‚Ø±ÙˆØ¨Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }

    const myMembership = members.find(
      m => m.groupId === currentGroupId && m.userId === currentUserId && m.approved
    );
    if(!myMembership){
      alertMsg('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆØ©.');// Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
      return;
    }

    const input = document.getElementById('chatInput');
    const text  = input.value.trim();
    if(!text) return;

    messages.push({
      id: uid(),
      groupId: currentGroupId,
      from: currentUserId,
      text,
      createdAt: new Date().toISOString()
    });
    save('rs_group_msgs', messages);

    input.value = '';
    loadChatMessages();
  }

  window.addEventListener('load', ()=>{
    if(!ensureUser()) return;
    renderInvites();
    renderGroups();
  });

  function goHome(){
    const role = localStorage.getItem('rs_current_role') || '';

    if (role === 'driver') {
      location.href = 'driverHome.html';
    } else if (role === 'passenger') {
      location.href = 'passengerHome.html';
    } else {
      location.href = 'index.html'; 
    }
  }
</script>
</body>
</html>