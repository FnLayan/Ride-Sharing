<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إنشاء / جدولة رحلة</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap');
    :root{--bg:#f8f3ee;--card:#fffdf9;--border:#ddd0c8;--accent:#cbb796;--accent-hover:#b29a75;--text:#3b2f24;--muted:#7a6a57;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);font-family:'Tajawal',sans-serif;color:var(--text)}
    .container{width:520px;max-width:96%;padding:22px;border-radius:12px;background:var(--card);border:1px solid var(--border);box-shadow:0 8px 26px rgba(0,0,0,.08);text-align:right}
    h1{margin:0 0 14px;font-size:20px;color:var(--muted);text-align:center}
    label{display:block;font-size:13px;margin:8px 0 4px;color:var(--muted)}
    input,textarea{width:100%;padding:10px;border:1px solid #e6dcca;border-radius:6px;background:#fff;font-size:14px}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-block;background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;margin-top:12px;font-weight:600}
    .btn:hover{background:var(--accent-hover)}
    .status{margin-top:10px;padding:8px;border-radius:6px;font-size:13px}
    .error{background:rgba(206,86,86,.08);color:#7a1f1f;border:1px solid rgba(206,86,86,.12)}
    .success{background:rgba(108,169,99,.12);color:#256029;border:1px solid rgba(108,169,99,.2)}

    .map-box{margin-top:12px}
    .map-label{font-size:13px;color:var(--muted);margin-bottom:4px}
    #map{height:260px;border-radius:10px;border:1px solid #e0d6c8}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:6px}
    .seg button{background:#fff;border:0;padding:6px 10px;font-size:12px;cursor:pointer}
    .seg button.active{background:var(--accent);color:#fff}
    .hint{font-size:12px;color:#9a8b7a;margin-top:4px}
    /* نخفي إدخال الأحداثيات */
    #inFromLat,
    #inFromLng,
    #inToLat,
    #inToLng {
      display: none;
    }

    label[for="inFromLat"],
    label[for="inFromLng"],
    label[for="inToLat"],
    label[for="inToLng"] {
      display: none;
    }
    .row:nth-of-type(1) {
      display: none;
    }
    .row:nth-of-type(2) {
      display: none;
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <h1>إنشاء / جدولة رحلة</h1>

    <label>نقطة الانطلاق</label>
<input id="inFrom" type="text" placeholder="مثال: بوابة 3 - الجامعة">
<button
  type="button"
  class="btn"
  style="margin-top:4px;padding:6px 10px;font-size:12px"
  onclick="pickFromCampus()"
>
  اختيار من خريطة الجامعة
</button>
    <div class="row">
      <div style="flex:1">
        <label>خط العرض (lat)</label>
        <input id="inFromLat" type="number" step="0.000001" placeholder="24.7">
      </div>
      <div style="flex:1">
        <label>خط الطول (lng)</label>
        <input id="inFromLng" type="number" step="0.000001" placeholder="46.7">
      </div>
    </div>

    <label>نقطة الوصول</label>
    <input id="inTo" type="text" placeholder="مثال: مخرج 8 - حي الياسمين">
    <button
      type="button"
      class="btn"
      style="margin-top:4px;padding:6px 10px;font-size:12px"
      onclick="pickToCampus()"
    >
      اختيار من خريطة الجامعة
    </button>
    <div class="row">
      <div style="flex:1">
        <label>خط العرض (lat)</label>
        <input id="inToLat" type="number" step="0.000001" placeholder="24.65">
      </div>
      <div style="flex:1">
        <label>خط الطول (lng)</label>
        <input id="inToLng" type="number" step="0.000001" placeholder="46.71">
      </div>
    </div>

    <!-- زر اختيار كلا النقطتين من خريطة الجامعة -->
  <button
    type="button"
    class="btn"
    style="margin-top:6px;padding:6px 10px;font-size:12px"
    onclick="pickBothFromCampus()"
  >
    اختيار الانطلاق والوصول من خريطة الجامعة
  </button>
    <!-- الخريطة لاختيار الإحداثيات -->
    <div class="map-box">
      <div class="map-label">تحديد الإحداثيات من الخريطة:</div>
      <div class="seg">
        <button id="pickFromBtn" class="active" type="button" onclick="setPickMode('from')">تحديد الانطلاق</button>
        <button id="pickToBtn"   type="button" onclick="setPickMode('to')">تحديد الوصول</button>
      </div>
      <div class="hint">اضغطي على الخريطة لاختيار النقطة.</div>

  

  <div id="map"></div>
</div>

    <label>وقت المغادرة</label>
    <input id="inTime" type="datetime-local">

    <div class="row">
      <div style="flex:1">
        <label>عدد المقاعد</label>
        <input id="inSeats" type="number" min="1" value="1">
      </div>
      <div style="flex:1">
        <label>ملاحظات (اختياري)</label>
        <input id="inNotes" type="text" placeholder="مثال: طالبات فقط / بدون تدخين">
      </div>
    </div>

    <button class="btn" onclick="saveRide()">حفظ الرحلة</button>
    <button class="btn" style="background:#d87a6b" onclick="location.href='driverHome.html'">رجوع</button>

    <div id="msg"></div>
  </div>

  <script src="notifications-bar.js"></script>
  <script>
    function loadUsers(){ return JSON.parse(localStorage.getItem('rs_users') || '[]'); }
    function getCurrentUserId(){ return localStorage.getItem('rs_current_user_id') || ''; }

    function loadRides(){ 
      try{
        return JSON.parse(localStorage.getItem('rs_rides') || '[]'); 
      }catch(e){
        return [];
      }
    }
    function saveRides(list){ localStorage.setItem('rs_rides', JSON.stringify(list)); }

    // ===== الخريطة واختيار الإحداثيات =====
    let map, fromMarker, toMarker, pickMode = 'from';

    function setPickMode(mode){
      pickMode = mode;
      document.getElementById('pickFromBtn').classList.toggle('active', mode === 'from');
      document.getElementById('pickToBtn').classList.toggle('active', mode === 'to');
    }

    function initMap(){
  map = L.map('map').setView([24.7136, 46.6753], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '©️ OpenStreetMap'
  }).addTo(map);

  // نرسم الأسهم إذا فيه إحداثيات جاهزة من جت اختيار من الخريطه الجامعيه
  const fromLat = parseFloat(document.getElementById('inFromLat').value);
  const fromLng = parseFloat(document.getElementById('inFromLng').value);
  const toLat   = parseFloat(document.getElementById('inToLat').value);
  const toLng   = parseFloat(document.getElementById('inToLng').value);

  const bounds = [];

  if(!isNaN(fromLat) && !isNaN(fromLng)){
    fromMarker = L.marker([fromLat, fromLng]).addTo(map).bindPopup('نقطة الانطلاق');
    bounds.push([fromLat, fromLng]);
  }

  if(!isNaN(toLat) && !isNaN(toLng)){
    toMarker = L.marker([toLat, toLng]).addTo(map).bindPopup('نقطة الوصول');
    bounds.push([toLat, toLng]);
  }

  if(bounds.length){
    map.fitBounds(bounds, {padding:[30,30]});
  }

  map.on('click', function(e){
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);

    if(pickMode === 'from'){
      document.getElementById('inFromLat').value = lat;
      document.getElementById('inFromLng').value = lng;

      if(fromMarker) map.removeLayer(fromMarker);
      fromMarker = L.marker(e.latlng).addTo(map).bindPopup('نقطة الانطلاق').openPopup();
    }else{
      document.getElementById('inToLat').value = lat;
      document.getElementById('inToLng').value = lng;

      if(toMarker) map.removeLayer(toMarker);
      toMarker = L.marker(e.latlng).addTo(map).bindPopup('نقطة الوصول').openPopup();
    }
  });
}
  
    function saveRide(){
      const msg = document.getElementById('msg'); 
      msg.innerHTML='';

      const driverId = getCurrentUserId();
      if(!driverId){
        msg.innerHTML = '<div class="status error">لا يوجد جلسة سائق. سجّل دخولك أولاً.</div>';
        return;
      }

      const users = loadUsers();
      const me = users.find(u => u.id === driverId);
      if(!me || me.role !== 'driver'){
        msg.innerHTML = '<div class="status error">هذا الحساب ليس سائقًا.</div>';
        return;
      }
      if(!me.verified){
        msg.innerHTML = '<div class="status error">يجب أن يكون حسابك كسائق مُفعل من الأدمن قبل إنشاء رحلة.</div>';// لو كنا في حالة التطوير حاولنا ننشئ رحله ناسين اننا ما سجلنا دخول
        return;
      }

      const from = document.getElementById('inFrom').value.trim();
      const to   = document.getElementById('inTo').value.trim();
      const time = document.getElementById('inTime').value;
      const seats= parseInt(document.getElementById('inSeats').value, 10);
      const notes= document.getElementById('inNotes').value.trim();

      const fromLat = parseFloat(document.getElementById('inFromLat').value);
      const fromLng = parseFloat(document.getElementById('inFromLng').value);
      const toLat   = parseFloat(document.getElementById('inToLat').value);
      const toLng   = parseFloat(document.getElementById('inToLng').value);

      if(!from || !to){
        msg.innerHTML = '<div class="status error">يرجى إدخال نقطة الانطلاق ونقطة الوصول.</div>';
        return;
      }
      if(isNaN(fromLat) || isNaN(fromLng) || isNaN(toLat) || isNaN(toLng)){
        msg.innerHTML = '<div class="status error">يرجى إدخال إحداثيات صحيحة (lat / lng) لنقطة الانطلاق والوصول.</div>';
        return;
      }
      if(!time){
        msg.innerHTML = '<div class="status error">يرجى تحديد وقت المغادرة.</div>';
        return;
      }
      const dep = new Date(time);
      const now = new Date();
      if(dep <= now){
        msg.innerHTML = '<div class="status error">وقت المغادرة يجب أن يكون مستقبلي.</div>';
        return;
      }
      if(!seats || seats < 1){
        msg.innerHTML = '<div class="status error">عدد المقاعد يجب أن يكون رقمًا موجبًا.</div>';
        return;
      }

      const rides = loadRides();

      // منع وجود أكثر من رحله نشطه لنفس السائق
      const hasActive = rides.some(r =>
      r.driverId === driverId &&
      ['open','pending_payment','in_progress'].includes(r.status || 'open')
      );
      if(hasActive){
        msg.innerHTML = '<div class="status error">لا يمكنك إنشاء رحلة جديدة لأن لديك رحلة نشطة (لم تبدأ / بانتظار الدفع / جارية). أنهي أو أكمل الرحلة الحالية أولاً.</div>';
      return;
      }

      const rideId = 'ride-' + Date.now();
      const ride = {
        id: rideId,
        driverId: driverId,
        driverName: me.name,
        from: { name: from, lat: fromLat, lng: fromLng },
        to:   { name: to,   lat: toLat,   lng: toLng   },
        departAt: dep.toISOString(),
        seats: seats,
        notes: notes,
        status: 'open',
        createdAt: new Date().toISOString()
      };

      rides.push(ride);
      saveRides(rides);

      // نحفظ الرحلة الحالية وننتقل لصفحة currentRide
      localStorage.setItem('rs_current_ride_id', rideId);
      localStorage.setItem('rs_current_ride_role', 'driver');

      // ممكن بس نعرض رسالة سريعة ثم ننتقل
      msg.innerHTML = '<div class="status success">تم حفظ الرحلة، سيتم نقلك لواجهة الرحلة الحالية.</div>';
      setTimeout(()=>{ location.href = 'currentRide.html'; }, 600);
    }

    function pickFromCampus(){
    // أختار فقط نقطة الانطلاق من خريطة الجامعة
      localStorage.setItem('rs_campus_pick_target', 'from');
      location.href = 'campusMap.html';
    }

    function pickToCampus(){
      // أختار فقط نقطة الوصول من خريطة الجامعة
      localStorage.setItem('rs_campus_pick_target', 'to');
      location.href = 'campusMap.html';
    }

    function pickBothFromCampus(){
      // أختار الانطلاق + الوصول معاً من نفس زيارة الخريطة
      localStorage.setItem('rs_campus_pick_target', 'both');
      location.href = 'campusMap.html';
    }

    function applyCampusSelection(){
      const raw = localStorage.getItem('rs_campus_selected_points');
      if(!raw) return;

      const obj = JSON.parse(raw);
      if(obj.from){
        document.getElementById('inFrom').value = obj.from.name;
        document.getElementById('inFromLat').value = obj.from.lat;
        document.getElementById('inFromLng').value = obj.from.lng;
      }
      if(obj.to){
        document.getElementById('inTo').value = obj.to.name;
        document.getElementById('inToLat').value = obj.to.lat;
        document.getElementById('inToLng').value = obj.to.lng;
      }

      localStorage.removeItem('rs_campus_selected_points');
    }

    window.addEventListener('load', applyCampusSelection);
    window.addEventListener('load', initMap);
  </script>
</body>
</html>